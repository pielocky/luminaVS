name: Build Android APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
          pip install --upgrade pip
          pip install buildozer cython pillow

      - name: Setup Android SDK and NDK from GitHub runner
        run: |
          # Используем предустановленный NDK
          echo "ANDROID_NDK=/usr/local/lib/android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          
          # Создаем символические ссылки для buildozer
          mkdir -p ~/.buildozer/android/platform
          ln -s /usr/local/lib/android/sdk ~/.buildozer/android/platform/android-sdk
          ln -s /usr/local/lib/android/sdk/ndk/25.2.9519653 ~/.buildozer/android/platform/android-ndk

      - name: Pre-download numpy from Russian mirror
        run: |
          mkdir -p ~/.buildozer/android/packages/numpy/
          wget https://mirror.yandex.ru/pypi/packages/source/n/numpy/numpy-1.23.5.tar.gz \
               -O ~/.buildozer/android/packages/numpy/numpy-1.23.5.tar.gz
          touch ~/.buildozer/android/packages/numpy/.mark-numpy-1.23.5.tar.gz

      - name: Build with buildozer
        run: |
          buildozer android debug